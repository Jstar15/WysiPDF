<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WysiPDF Demo</title>
  <script src="./wysipdf.bundle.js"></script>
  <style>
    :root {
      --primary: #1976d2;
      --primary-hover: #125aa1;
    }
    #downloadBtn, #importBtn {
      position: fixed;
      padding: 8px 14px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 9999;
    }
    #downloadBtn:hover, #importBtn:hover { background-color: var(--primary-hover); }
    #downloadBtn { bottom: 30px; right: 25px; }
    #importBtn  { bottom: 30px; right: 145px; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 10000;
    }
    .modal {
      width: 90%; max-width: 900px;
      background: #fff; border-radius: 8px; overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal-header, .modal-footer {
      padding: 12px 16px; background: #f7f7f7; display: flex; align-items: center; justify-content: space-between;
    }
    .modal-title { font-weight: 600; }
    .modal-body { padding: 12px 16px; }
    .json-input {
      width: 100%; height: 300px; resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 13px; line-height: 1.45;
      border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;
      outline: none;
    }
    .json-input:focus { border-color: #c5c5c5; box-shadow: 0 0 0 3px rgba(25,118,210,0.10); }
    .btn {
      padding: 8px 12px; border: 0; border-radius: 4px; cursor: pointer; font-size: 14px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-ghost { background: transparent; }
    .error {
      color: #b00020; font-size: 13px; margin-top: 8px; white-space: pre-wrap;
    }
    .hint {
      font-size: 12px; color: #666; margin-bottom: 8px;
    }
  </style>
</head>
<body>

<!-- Floating buttons -->
<button id="importBtn">Import JSON</button>
<button id="downloadBtn">Download PDF</button>

<!-- Editor component -->
<app-template-editor></app-template-editor>

<!-- Import Modal -->
<div id="importModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="importTitle">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="importTitle">Import Page Payload</div>
      <button id="closeModalBtn" class="btn btn-ghost" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="hint">
        Paste a full <code>page</code> object (e.g. with <code>header</code>, <code>content</code>, <code>footer</code>,
        <code>pageAttrs</code>, <code>tokenAttrs</code>, <code>partialContent</code>). Example keys will be validated.
      </div>
      <textarea id="jsonInput" class="json-input" placeholder='{
  "header": { "rows": [] },
  "content": { "rows": [] },
  "footer": { "rows": [] },
  "pageAttrs": { "defaultFont": "Roboto" },
  "tokenAttrs": [{ "name": "customerName", "value": "John Doe", "type": "TEXT" }],
  "partialContent": []
}'></textarea>
      <div id="importError" class="error" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <div></div>
      <div>
        <button id="cancelImportBtn" class="btn btn-ghost">Cancel</button>
        <button id="confirmImportBtn" class="btn btn-primary">Load</button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = null;

  function showModal() {
    document.getElementById('importModal').style.display = 'flex';
    document.getElementById('importError').style.display = 'none';
    document.getElementById('jsonInput').focus();
  }
  function hideModal() {
    document.getElementById('importModal').style.display = 'none';
  }
  function setError(msg) {
    const el = document.getElementById('importError');
    el.textContent = msg;
    el.style.display = msg ? 'block' : 'none';
  }

  function looksLikePage(obj) {
    // Lightweight shape check; keeps it flexible but catches obvious mistakes
    return obj && typeof obj === 'object'
            && 'content' in obj
            && 'pageAttrs' in obj
            && 'header' in obj
            && 'footer' in obj;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // Default starter page
    const page = {
      header: { rows: [] },
      content: { rows: [] },
      footer: { rows: [] },
      pageAttrs: {
        backgroundColor: 'white',
        marginTop: 10,
        marginRight: 0,
        marginLeft: 0,
        marginBottom: 10,
        footerMargin: 50,
        headerMargin: 30,
        defaultFont: 'Roboto'
      },
      tokenAttrs: [
        { name: 'customerName', value: 'John Doe', type: 'TEXT' }
      ],
      partialContent: []
    };

    currentPage = page;
    await window.loadPage(page);

    await window.onPageChange(updatedPage => {
      currentPage = updatedPage;
      console.log('Page was updated:', updatedPage);
    });

    // Download PDF
    document.getElementById('downloadBtn').addEventListener('click', async () => {
      if (!currentPage) return;
      const tokens = currentPage.tokenAttrs || [];
      const base64 = await window.generatePdfBase64(currentPage, tokens);
      const link = document.createElement('a');
      link.href = 'data:application/pdf;base64,' + base64;
      link.download = 'wysipdf-document.pdf';
      link.click();
    });

    // Import handlers
    document.getElementById('importBtn').addEventListener('click', showModal);
    document.getElementById('closeModalBtn').addEventListener('click', hideModal);
    document.getElementById('cancelImportBtn').addEventListener('click', hideModal);

    document.getElementById('confirmImportBtn').addEventListener('click', async () => {
      const raw = document.getElementById('jsonInput').value.trim();
      if (!raw) { setError('Please paste a JSON page payload.'); return; }
      try {
        const parsed = JSON.parse(raw);
        if (!looksLikePage(parsed)) {
          setError('This JSON does not look like a WysiPDF page: expected keys header/content/footer/pageAttrs.');
          return;
        }
        // Optional: shallow defaults to protect missing keys
        parsed.header = parsed.header || { rows: [] };
        parsed.content = parsed.content || { rows: [] };
        parsed.footer = parsed.footer || { rows: [] };
        parsed.pageAttrs = parsed.pageAttrs || { defaultFont: 'Roboto' };
        parsed.tokenAttrs = parsed.tokenAttrs || [];
        parsed.partialContent = parsed.partialContent || [];

        await window.loadPage(parsed);
        currentPage = parsed;
        hideModal();
      } catch (e) {
        setError('Invalid JSON: ' + (e && e.message ? e.message : String(e)));
      }
    });
  });
</script>

</body>
</html>
